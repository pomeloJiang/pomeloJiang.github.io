<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">

    

    

    <title>Android系统启动分析(二) | 柚子 | pomeloJiang</title>
    <meta name="author" content="pomeloJiang">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content="Android | Java | 算法">
    <meta name="description" content="本节是本系列文章的第二篇,将分析Zygote进程的启动过程。第一篇文章:Android系统启动分析(一)第三篇文章:Android系统启动分析(三)二、Zygote进程启动上节分析了Init进程的启动流程。本节将进入到framework层,分析Zygote进程的启动流程。本节涉及到的文件有:			文件		路径				app_main.cpp		framework/cmds/app_process/app_main.cpp				AndroidRuntime....">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

    
    <link rel="alternate" href="/atom.xml" title="柚子 | pomeloJiang" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <main class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">柚子 | pomeloJiang</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">Home</span>
            </a>
        
            <a class="nav-item" href="/categories/android">
                <span class="nav-text">Android</span>
            </a>
        
            <a class="nav-item" href="/categories/java">
                <span class="nav-text">Java</span>
            </a>
        
            <a class="nav-item" href="/categories/notes">
                <span class="nav-text">Notes</span>
            </a>
        
            <a class="nav-item" href="/categories/chat">
                <span class="nav-text">Chat</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">Archives</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">About</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://pomelojiang.github.io"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Zygote进程启动"><span class="toc-number">1.</span> <span class="toc-text">二、Zygote进程启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-app-main-main"><span class="toc-number">1.1.</span> <span class="toc-text">2.1 app_main.main()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-AppRuntime-start"><span class="toc-number">1.2.</span> <span class="toc-text">2.2 AppRuntime.start</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-ZygoteInit-main"><span class="toc-number">1.3.</span> <span class="toc-text">2.3 ZygoteInit.main()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-registerServerSocket"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.3.1 registerServerSocket</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-预加载类和资源-preload"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.3.2 预加载类和资源 preload()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-forkSystemServer"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3.3  forkSystemServer()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-4-runSelectLoop"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.3.4 runSelectLoop()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Zygote进程启动总结"><span class="toc-number">1.4.</span> <span class="toc-text">2.4 Zygote进程启动总结</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content"><article class="article" itemscope="" itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            Android系统启动分析(二)
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://pomelojiang.github.io/android_system_booting_2.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-12-16T16:00:00.000Z" itemprop="datePublished">2018-12-17</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/Android/">Android</a>, <a class="article-tag-link" href="/tags/Frameworks/">Frameworks</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>本节是本系列文章的第二篇,将分析Zygote进程的启动过程。</p>
<p>第一篇文章:<a href="./android_system_booting_1.html">Android系统启动分析(一)</a>
第三篇文章:<a href="./android_system_booting_3.html">Android系统启动分析(三)</a></p>
<h2 id="二、Zygote进程启动"><a href="#二、Zygote进程启动" class="headerlink" title="二、Zygote进程启动"></a>二、Zygote进程启动</h2><p>上节分析了Init进程的启动流程。本节将进入到framework层,分析Zygote进程的启动流程。</p>
<p>本节涉及到的文件有:

<table>
	<tr>
		<td>文件</td>
		<td>路径</td>
	</tr>
	<tr>
		<td>app_main.cpp</td>
		<td>framework/cmds/app_process/app_main.cpp</td>
	</tr>
	<tr>
		<td>AndroidRuntime.cpp</td>
		<td>frameworks/base/core/jni/AndroidRuntime.cpp</td>
	</tr>
	<tr>
		<td>ZygoteInit.java</td>
		<td>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</td>
	</tr>
	<tr>
		<td>ZygoteServer.java</td>
		<td>frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</td>
	</tr>
</table>
</p>
<h3 id="2-1-app-main-main"><a href="#2-1-app-main-main" class="headerlink" title="2.1 app_main.main()"></a>2.1 app_main.main()</h3><p>大家都知道Zygote进程相当于是Android的根进程,后面所有进程都是该进程fork出来的,而Zygote进程则是由Init进程fork而来。先看看Zygote进程是如何启动的。
进入到app_main的main()函数
<a id="more"></a></p>
<table><tr><td bgcolor="#D2D2D2"><font face="微软雅黑"> framework/cmds/app_process/app_main.cpp </font></td></tr></table>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ……</span><br><span class="line">    <span class="function">AppRuntime <span class="title">runtime</span><span class="params">(argv[<span class="number">0</span>], computeArgBlockSize(argc, argv))</span></span>;</span><br><span class="line">	……</span><br><span class="line">    <span class="comment">//注释1:解析传进来的参数</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--"</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ……</span><br><span class="line">    <span class="comment">//注释2</span></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        ……</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>注释1处:将解析传进来的参数,由init.zygote64_32.rc文件可知,传进来的参数为:<strong>“-Xzygote /system/bin –zygote –start-system-server –socket-name=zygote”</strong>,因此argv[]数组大小为4,执行过注释1处的while循环后,zygote = true,startSystemServer = true</li>
<li>注释2处:将执行runtime.start(“com.android.internal.os.ZygoteInit”, args, zygote)</li>
</ol>
<h3 id="2-2-AppRuntime-start"><a href="#2-2-AppRuntime-start" class="headerlink" title="2.2 AppRuntime.start"></a>2.2 AppRuntime.start</h3><table><tr><td bgcolor="#D2D2D2"><font face="微软雅黑"> framework/cmds/app_process/app_main.cpp </font></td></tr></table>

<p>AppRuntime定义在app_main.cpp中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRuntime</span> :</span> <span class="keyword">public</span> AndroidRuntime</span><br><span class="line">&#123;</span><br><span class="line">   ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其父类为AndroidRuntime类,AppRuntime并没有实现start方法,因此前面的调用将会进入到AndroidRuntime的start()函数。</p>
<table><tr><td bgcolor="#D2D2D2"><font face="微软雅黑"> frameworks/base/core/jni/AndroidRuntime.cpp </font></td></tr></table>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span><br><span class="line">&#123;</span><br><span class="line">	……</span><br><span class="line">	<span class="comment">//获取根目录</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">"ANDROID_ROOT"</span>);</span><br><span class="line">    <span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        rootDir = <span class="string">"/system"</span>;</span><br><span class="line">        <span class="keyword">if</span> (!hasDir(<span class="string">"/system"</span>)) &#123;</span><br><span class="line">            LOG_FATAL(<span class="string">"No root directory specified, and /android does not exist."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setenv(<span class="string">"ANDROID_ROOT"</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注释1:创建虚拟机</span></span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.Init(<span class="literal">NULL</span>);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//回调AppRuntime的onVmCreate函数</span></span><br><span class="line">    onVmCreated(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注释2:注册JNI函数</span></span><br><span class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	……</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//注释3:将classname的"."替换为"/"</span></span><br><span class="line">    <span class="comment">//如: "com.android.internal.os.ZygoteInit"替换为"com/android/internal/os/ZygoteInit"</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className != <span class="literal">NULL</span> ? className : <span class="string">""</span>);</span><br><span class="line">    <span class="comment">//根据路径找到class文件</span></span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		……</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">//注释4:通过反射找到ZygoteInit.main()函数</span></span><br><span class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</span><br><span class="line">            <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">           ……</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="comment">//注释5:调用ZygoteInit.main()函数</span></span><br><span class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</span><br><span class="line">        ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</span><br><span class="line">        ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释1处:jni_invocation.Init(NULL)初始化JNI,调用startVm() 创建Java虚拟机
注释2处:通过startReg()注册JNI函数,定义Android创建线程的函数:javaCreateThreadEtc
注释3处:toSlashClassName()将classname的”.”替换为”/“
注释4、5:通过JNI调用ZygoteInit.main()函数,至此,Zygote进程来到了Java代码。</p>
<h3 id="2-3-ZygoteInit-main"><a href="#2-3-ZygoteInit-main" class="headerlink" title="2.3 ZygoteInit.main()"></a>2.3 ZygoteInit.main()</h3><table><tr><td bgcolor="#D2D2D2"><font face="微软雅黑"> frameworks/base/core/java/com/android/internal/os/ZygoteInit.java </font></td></tr></table>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">	ZygoteServer zygoteServer = <span class="keyword">new</span> ZygoteServer();</span><br><span class="line">	……</span><br><span class="line">	final Runnable caller;</span><br><span class="line">    <span class="comment">//注释1:设置DDMS可用</span></span><br><span class="line">    RuntimeInit.enableDdms();</span><br><span class="line"></span><br><span class="line">    boolean startSystemServer = <span class="literal">false</span>;</span><br><span class="line">    String socketName = <span class="string">"zygote"</span>;</span><br><span class="line">    String abiList = null;</span><br><span class="line">    boolean enableLazyPreload = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//根据参数处理一些标志</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"start-system-server"</span>.equals(argv[i])) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"--enable-lazy-preload"</span>.equals(argv[i])) &#123;</span><br><span class="line">            enableLazyPreload = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">            abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">    		socketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unknown command line argument: "</span> + argv[i]);</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">	……</span><br><span class="line">	<span class="comment">//注释2:创建一个Server端的值为"zygote"的Socket</span></span><br><span class="line">	zygoteServer.registerServerSocket(socketName);</span><br><span class="line">	<span class="keyword">if</span> (!enableLazyPreload) &#123;</span><br><span class="line">		<span class="comment">//注释3</span></span><br><span class="line">		preload(bootTimingsTraceLog);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		Zygote.resetNicePriority();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Zygote process unmounts root storage spaces.</span></span><br><span class="line">	Zygote.nativeUnmountStorageOnInit();</span><br><span class="line">	ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class="line">	<span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">		<span class="comment">//注释4:启动SystemServer进程</span></span><br><span class="line">		Runnable r = forkSystemServer(abiList, socketName, zygoteServer);</span><br><span class="line">		<span class="comment">//在Zygote进程中,r == null;在子进程中,r != null</span></span><br><span class="line">		<span class="keyword">if</span> (r != null) &#123;</span><br><span class="line">			r.run();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="comment">//注释5:死循环,等待客户端请求</span></span><br><span class="line">		caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		Log.e(TAG, <span class="string">"System zygote died with exception"</span>, ex);</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125; finally &#123;</span><br><span class="line">		zygoteServer.closeServerSocket();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (caller != null) &#123;</span><br><span class="line">		caller.run();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释1处:设置DDMS可用,DDMS在Zygote进程刚刚开始启动时便已设置
注释2处:创建一个值为”zygote”的Socket服务端,可以看到这里Zygote作为Server端,处理客户端的请求
注释3处:初始化Zygote中需要的Class类,初始化各类系统资源和库
注释4处:fork一个SystemServer进程
注释5处:调用ZygoteServer的runSelectLoop方法等待客户端(AMS)的创建新进程的请求<a href="#runSelectLoop">点我跳转</a></p>
<h4 id="2-3-1-registerServerSocket"><a href="#2-3-1-registerServerSocket" class="headerlink" title="2.3.1 registerServerSocket"></a>2.3.1 registerServerSocket</h4><table><tr><td bgcolor="#D2D2D2"><font face="微软雅黑"> frameworks/base/core/java/com/android/internal/os/ZygoteServer.java </font></td></tr></table>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerServerSocket</span><span class="params">(String socketName)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (mServerSocket == null) &#123;</span><br><span class="line">		<span class="keyword">int</span> fileDesc;</span><br><span class="line">		<span class="comment">//拼接SocketName,"ANDROID_SOCKET_"+socketName</span></span><br><span class="line">		final String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String env = System.getenv(fullSocketName);</span><br><span class="line">			fileDesc = Integer.parseInt(env);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(fullSocketName + <span class="string">" unset or invalid"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">			<span class="comment">//设置文件描述符</span></span><br><span class="line">			fd.setInt$(fileDesc);</span><br><span class="line">			<span class="comment">//创建Socket的本地服务端,将文件描述符赋值给LocalServerSocket</span></span><br><span class="line">			mServerSocket = <span class="keyword">new</span> LocalServerSocket(fd);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">					<span class="string">"Error binding to local socket '"</span> + fileDesc + <span class="string">"'"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-2-预加载类和资源-preload"><a href="#2-3-2-预加载类和资源-preload" class="headerlink" title="2.3.2 预加载类和资源 preload()"></a>2.3.2 预加载类和资源 preload()</h4><table><tr><td bgcolor="#D2D2D2"><font face="微软雅黑"> frameworks/base/core/java/com/android/internal/os/ZygoteInit.java </font></td></tr></table> 

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">(TimingsTraceLog bootTimingsTraceLog)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//预加载Zygote需要用到的Class类</span></span><br><span class="line">	<span class="comment">//class文件的地址为:"/system/etc/preloaded-classes"</span></span><br><span class="line">	preloadClasses();</span><br><span class="line">	<span class="comment">//加载drawable和color等资源</span></span><br><span class="line">	preloadResources();</span><br><span class="line">	nativePreloadAppProcessHALs();</span><br><span class="line">	<span class="comment">//预加载OpenGL</span></span><br><span class="line">	preloadOpenGL();</span><br><span class="line">	<span class="comment">//调用System.loadLibrary()预加载"android"、"compiler_rt"、"jnigraphics"三个共享库</span></span><br><span class="line">	preloadSharedLibraries();</span><br><span class="line">	<span class="comment">//初始化字体资源</span></span><br><span class="line">	preloadTextResources();</span><br><span class="line">	WebViewFactory.prepareWebViewInZygote();</span><br><span class="line">	warmUpJcaProviders();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-3-forkSystemServer"><a href="#2-3-3-forkSystemServer" class="headerlink" title="2.3.3  forkSystemServer()"></a>2.3.3  forkSystemServer()</h4><p><table><tr><td bgcolor="#D2D2D2"><font face="微软雅黑"> frameworks/base/core/java/com/android/internal/os/ZygoteInit.java </font></td></tr></table> 
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Runnable <span class="title">forkSystemServer</span><span class="params">(String abiList, String socketName,</span></span></span><br><span class="line"><span class="function"><span class="params">		ZygoteServer zygoteServer)</span> </span>&#123;</span><br><span class="line">	……</span><br><span class="line">	<span class="comment">//注释1:准备一些启动参数</span></span><br><span class="line">	String args[] = &#123;</span><br><span class="line">		<span class="string">"--setuid=1000"</span>,</span><br><span class="line">		<span class="string">"--setgid=1000"</span>,</span><br><span class="line">		<span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1032,3001,3002,3003,3006,3007,3009,3010"</span>,</span><br><span class="line">		<span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</span><br><span class="line">		<span class="string">"--nice-name=system_server"</span>,</span><br><span class="line">		<span class="string">"--runtime-args"</span>,</span><br><span class="line">		<span class="string">"com.android.server.SystemServer"</span>,</span><br><span class="line">	&#125;;</span><br><span class="line">	ZygoteConnection.Arguments parsedArgs = null;</span><br><span class="line">	<span class="keyword">int</span> pid;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//注释2:将启动参数封装到ZygoteConnection.Arguments中</span></span><br><span class="line">		parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</span><br><span class="line">		ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">		ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line">		<span class="comment">//注释3:调用Zygote.forkSystemServer()</span></span><br><span class="line">		pid = Zygote.forkSystemServer(</span><br><span class="line">				parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">				parsedArgs.gids,</span><br><span class="line">				parsedArgs.debugFlags,</span><br><span class="line">				null,</span><br><span class="line">				parsedArgs.permittedCapabilities,</span><br><span class="line">				parsedArgs.effectiveCapabilities);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//如果pid == 0,当前代码逻辑运行在子进程中</span></span><br><span class="line">	<span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//如果有第二个Zygote,则等待第二个Zygote连接</span></span><br><span class="line">		<span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">			waitForSecondaryZygote(socketName);</span><br><span class="line">		&#125;</span><br><span class="line">		zygoteServer.closeServerSocket();</span><br><span class="line">		<span class="comment">//注释4:处理SystemServer进程</span></span><br><span class="line">		<span class="keyword">return</span> handleSystemServerProcess(parsedArgs);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注释1处:准备一些SystemServer进程的启动参数,类名为:com.android.server.SystemServer
注释2处:将启动参数封装到ZygoteConnection.Arguments中,具体在ZygoteConnection#parseArgs(),这里不再详细分析。
注释3处:调用Zygote.forkSystemServer(),可以看到SystemServer进程是被Zygote进程fork而来。最后会通过native方法nativeForkSystemServer()创建新进程。关于nativeForkSystemServer()的实现,可见<strong>frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</strong>
注释4处:如果注释3处返回的pid == 0,则此时代码逻辑运行在子进程中,这里会调用handleSystemServerProcess()来处理SystemServer进程。
关于SysetmServer进程,将在第三节分析。<a href="./android_system_booting_3.html">点我跳转</a></p>
<h4 id="2-3-4-runSelectLoop"><a href="#2-3-4-runSelectLoop" class="headerlink" title="2.3.4 runSelectLoop()"></a>2.3.4 runSelectLoop()</h4><p><span id="runSelectLoop"></span>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Runnable <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> </span>&#123;</span><br><span class="line">	ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">	ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line">	<span class="comment">//注释1:添加服务端的文件描述符到一个集合中</span></span><br><span class="line">	fds.add(mServerSocket.getFileDescriptor());</span><br><span class="line">	peers.add(null);</span><br><span class="line">	<span class="comment">//死循环,等待AMS的请求</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">		StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</span><br><span class="line">		<span class="comment">//将要观察的fd建立成数组</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">			pollFds[i] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">			pollFds[i].fd = fds.get(i);</span><br><span class="line">			pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//注释2:阻塞等待fd的变化</span></span><br><span class="line">			Os.poll(pollFds, <span class="number">-1</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//注释3:当fd有变化时(客户端有连接时),会进入该for循环</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">			<span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">//注释4:fds[0],即mServerSocket对象</span></span><br><span class="line">				ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">				peers.add(newPeer);</span><br><span class="line">				fds.add(newPeer.getFileDesciptor());</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">//注释5:</span></span><br><span class="line">					ZygoteConnection connection = peers.get(i);</span><br><span class="line">					final Runnable command = connection.processOneCommand(<span class="keyword">this</span>);</span><br><span class="line">					<span class="keyword">if</span> (mIsForkChild) &#123;</span><br><span class="line">						……</span><br><span class="line">                        <span class="keyword">return</span> command;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					……</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注释1处:添加服务端的文件描述符到fds集合中,文件描述符是在ZygoteServer.registerServerSocket()中创建,并封装给LocalServerSocket
注释2处:该处语句会阻塞,若fd发生变化,则解除阻塞状态
注释3处:若注释2处的语句解除阻塞,则会执行该处的for循环
注释4处: i==0时,意味着有客户端连接请求,创建新连接并处理请求
注释5处: i&gt;0,说明客户端(AMS)向Zygote发送了一个创建应用进程的请求,processOneCommand()方法会调用Zygote.forkAndSpecialize() fork一个新的VM实例,最终会进入到com_android_internal_os_Zygote.nativeForkAndSpecialize()函数。由于篇幅限制,这里不做过多介绍,感兴趣的读者可以自己去看。</p>
<h3 id="2-4-Zygote进程启动总结"><a href="#2-4-Zygote进程启动总结" class="headerlink" title="2.4 Zygote进程启动总结"></a>2.4 Zygote进程启动总结</h3><p>Zygote进程启动过程中主要做了以下几件事:</p>
<ol>
<li>调用AppRuntime.start()方法创建Java虚拟机,注册JNI函数</li>
<li>通过JNI调用ZygoteInit.main()方法</li>
<li>创建一个值为”zygote”的Socket服务端</li>
<li>预加载类和资源</li>
<li>创建SystemServer进程,并通过runSelectLoop()进入死循环监听Socket消息</li>
</ol>
<p>Zygote进程的启动分析到这里结束。下一节将介绍SystemServer进程的启动过程。
<a href="./android_system_booting_3.html">Android系统启动分析(三)</a></p>

        
    </section>
</article>



<div class="comments">
    <div id="comments"></div>
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    new Gitalk({
        clientID: "1d3d074e112b21d4b16b",
        clientSecret: "6cf434c1ab62299c7424dc86f574505eb2c1d175",
        repo: "pomelojiang.github.io",
        owner: "pomelojiang",
        admin: ["pomelojiang"],
        id: "android_system_booting_2.html",
        distractionFreeMode: true,
        title: "Android系统启动分析(二)",
        body: "http://pomelojiang.github.io/android_system_booting_2.html",
        labels: ["Frameworks","Android"]
    }).render('comments');
    </script>
</div>

</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }
            
            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    
        <script type="text/javascript" src="/js/scrollspy.min.js"></script>
        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});
        </script>
    

</body>
</html>
